<div class="bg-slate-100 rounded-lg p-4 flex flex-col h-[300px] mt-4 border border-slate-200">
  <h3 class="text-lg font-semibold text-slate-700 mb-2">Є питання? Запитай!</h3>
  
  <div #chatContainer class="flex-grow overflow-y-auto space-y-4 pr-2">
    @for (message of chatHistory(); track $index) {
      <div class="flex" [class.justify-end]="message.role === 'user'">
        <div 
          class="rounded-lg px-4 py-2 max-w-[80%]"
          [class.bg-sky-500]="message.role === 'user'"
          [class.text-white]="message.role === 'user'"
          [class.bg-white]="message.role === 'model'"
          [class.text-slate-700]="message.role === 'model'"
          [class.shadow-sm]="message.role === 'model'">
          @if (message.role === 'user') {
            <p class="text-sm whitespace-pre-wrap">{{ message.text }}</p>
          } @else {
            <div class="text-sm prose prose-slate max-w-none prose-p:my-1 prose-li:my-0.5" [innerHTML]="message.text"></div>
          }
        </div>
      </div>
    }
    @if(isGenerating()) {
        <div class="flex">
             <div class="rounded-lg px-4 py-2 max-w-[80%] bg-white text-slate-700 shadow-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
                </div>
             </div>
        </div>
    }
  </div>

  <div class="mt-4 flex items-center space-x-2 border-t border-slate-200 pt-3">
    <button 
      (click)="toggleListen()"
      [disabled]="isGenerating()"
      class="p-2 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
      [class.text-sky-600]="!isListening()"
      [class.bg-sky-100]="!isListening()"
      [class.hover:bg-sky-200]="!isListening()"
      [class.text-red-600]="isListening()"
      [class.bg-red-100]="isListening()"
      [class.hover:bg-red-200]="isListening()"
      [class.opacity-50]="isGenerating()"
      [class.cursor-not-allowed]="isGenerating()"
      aria-label="Записати голосове повідомлення">
      @if (isListening()) {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C10.9 2 10 2.9 10 4V12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12V4C14 2.9 13.1 2 12 2ZM17 12C17 14.76 14.76 17 12 17C9.24 17 7 14.76 7 12H5C5 15.54 7.72 18.42 11 18.93V22H13V18.93C16.28 18.42 19 15.54 19 12H17Z" />
        </svg>
      } @else {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c.49 0 .9.38.9.88v.24c0 2.71-2.01 4.97-4.72 5.31l-.28.03V21h-3.82v-1.54l-.28-.03C7.01 19.09 5 16.83 5 14.12v-.24c0-.5.41-.88.9-.88s.9.38.9.88v.24c0 2.02 1.55 3.68 3.59 3.91l.31.03V5c0-.97.83-1.8 1.8-1.8s1.8.83 1.8 1.8v6.94l.31-.03c2.04-.23 3.59-1.89 3.59-3.91v-.24c0-.5.41-.88.9-.88z"/>
        </svg>
      }
    </button>
    <input 
      type="text" 
      [ngModel]="userInput()"
      (ngModelChange)="userInput.set($event)"
      (keyup.enter)="sendMessage()"
      placeholder="Введіть ваше питання тут..."
      class="flex-grow p-2 border rounded-lg transition bg-slate-800 text-slate-100 placeholder:text-slate-400 border-slate-600 focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
      [disabled]="isGenerating()">
    <button 
      (click)="sendMessage()" 
      [disabled]="isGenerating() || userInput().trim() === ''"
      class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed">
      Надіслати
    </button>
  </div>
</div>